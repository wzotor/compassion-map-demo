{% extends "centers/base_staff.html" %}

{% block title %}Upload Participants{% endblock %}

{% block content %}
  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h3 class="mb-0">Upload Participants (CSV)</h3>
      <div class="text-muted">National Office only</div>
    </div>

    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="/admin/">
        Back to Admin
      </a>
    </div>
  </div>

  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="mb-2 fw-semibold">Required CSV columns</div>
      <pre class="bg-light p-3 rounded mb-0">center_code,participant_name,participant_id,sex,caregiver_name,house_latitude,house_longitude</pre>
      <div class="text-muted small mt-2">
        sex must be M or F. Coordinates must be valid (latitude -90 to 90, longitude -180 to 180).
      </div>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        {% if preview_rows %}
          <input type="hidden" name="confirm_import" value="1">
          <button class="btn btn-success" type="submit">
            Confirm Import
          </button>

          <a class="btn btn-outline-secondary ms-2" href="{% url 'participant_upload' %}">
            Upload a Different File
          </a>
        {% else %}
          <div class="mb-3">
            <label class="form-label">CSV File</label>
            {{ form.csv_file }}
            {% for error in form.csv_file.errors %}
              <div class="invalid-feedback d-block">{{ error }}</div>
            {% endfor %}
          </div>

          <button class="btn btn-primary" type="submit">
            Preview
          </button>
        {% endif %}
      </form>
    </div>
  </div>

  {% if preview_summary %}
    <div class="alert alert-info mt-3">
      Total rows: <strong>{{ preview_summary.total }}</strong> |
      Valid: <strong>{{ preview_summary.valid }}</strong> |
      Invalid: <strong>{{ preview_summary.invalid }}</strong>
    </div>
  {% endif %}

  {% if preview_rows %}
    <div class="card shadow-sm mt-3">
      <div class="card-body">
        <div class="fw-semibold mb-2">Preview (first {{ preview_rows|length }} rows)</div>

        <div class="table-responsive">
          <table class="table table-sm table-striped align-middle">
            <thead>
              <tr>
                <th>Status</th>
                <th>center_code</th>
                <th>participant_name</th>
                <th>participant_id</th>
                <th>sex</th>
                <th>caregiver_name</th>
                <th>house_latitude</th>
                <th>house_longitude</th>
                <th>Error</th>
              </tr>
            </thead>
            <tbody>
              {% for r in preview_rows %}
                <tr class="{% if not r.is_valid %}table-danger{% endif %}">
                  <td>
                    {% if r.is_valid %}
                      <span class="badge text-bg-success">OK</span>
                    {% else %}
                      <span class="badge text-bg-danger">Invalid</span>
                    {% endif %}
                  </td>
                  <td>{{ r.center_code }}</td>
                  <td>{{ r.participant_name }}</td>
                  <td>{{ r.participant_id }}</td>
                  <td>{{ r.sex }}</td>
                  <td>{{ r.caregiver_name }}</td>
                  <td>{{ r.house_latitude }}</td>
                  <td>{{ r.house_longitude }}</td>
                  <td class="small">{{ r.error }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="text-muted small mt-2">
          Invalid rows will not be imported. Fix errors and upload again if needed.
        </div>
      </div>
    </div>
  {% endif %}

{% endblock %}