<!-- centers/templates/centers/national_dashboard.html -->
{% extends "centers/base_staff.html" %}

{% block title %}National Dashboard | Compassion Map{% endblock %}

{% block extra_head %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      /* Compassion brand guide references PMS 286 Blue. :contentReference[oaicite:1]{index=1} */
      --ci-blue: #0033A0;   /* PMS 286 style deep blue */
      --ci-blue-2: #86BBE5; /* brand guide shows this light blue as a usable companion */
      --ci-ink: #0f172a;
      --ci-muted: #64748b;
      --ci-border: rgba(15, 23, 42, 0.10);
    }

    /* Page header */
    .dash-title{
      color: var(--ci-ink);
      letter-spacing: .2px;
    }

    /* Metric cards: tighter */
    .metric-card{
      border: 1px solid var(--ci-border);
      border-radius: 12px;
    }
    .metric-card .card-body{
      padding: .75rem .85rem;
    }
    .metric-label{
      color: var(--ci-muted);
      font-size: .78rem;
      line-height: 1.15;
    }
    .metric-value{
      color: var(--ci-blue);
      font-size: 1.35rem;
      font-weight: 700;
      margin-top: .15rem;
    }

    /* Cards: slightly tighter headers */
    .card-header{
      padding: .65rem .85rem;
    }
    .card-body{
      padding: .85rem;
    }

    /* Charts: fixed height for professional proportions */
    .chart-box{
      position: relative;
      height: 240px;
    }
    .chart-box.tall{
      height: 280px;
    }

    /* Tables: denser */
    .table thead th{
      font-size: .82rem;
      color: var(--ci-muted);
      white-space: nowrap;
    }
    .table tbody td{
      font-size: .86rem;
      vertical-align: middle;
    }
    .badge-ci{
      background: rgba(0, 51, 160, 0.12);
      color: var(--ci-blue);
      border: 1px solid rgba(0, 51, 160, 0.20);
    }
  </style>
{% endblock %}

{% block content %}
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <div>
      <h2 class="mb-0 dash-title">National Dashboard</h2>
      <div class="text-muted small">Quick analytics for centers, participants, and system activity.</div>
    </div>
    <div class="text-muted small">
      Last updated: {{ now|default:"" }}
    </div>
  </div>

  <!-- Metric cards: 6 across on xl screens -->
  <div class="row g-2 mb-3">
    <div class="col-6 col-md-4 col-xl-2">
      <div class="card metric-card shadow-sm h-100">
        <div class="card-body">
          <div class="metric-label">Total Project Centers</div>
          <div class="metric-value">{{ total_centers }}</div>
        </div>
      </div>
    </div>

    <div class="col-6 col-md-4 col-xl-2">
      <div class="card metric-card shadow-sm h-100">
        <div class="card-body">
          <div class="metric-label">Total Participants</div>
          <div class="metric-value">{{ total_participants }}</div>
        </div>
      </div>
    </div>

    <div class="col-6 col-md-4 col-xl-2">
      <div class="card metric-card shadow-sm h-100">
        <div class="card-body">
          <div class="metric-label">Activity Logs Last 7 Days</div>
          <div class="metric-value">{{ logs_last_7 }}</div>
        </div>
      </div>
    </div>

    <div class="col-6 col-md-4 col-xl-2">
      <div class="card metric-card shadow-sm h-100">
        <div class="card-body">
          <div class="metric-label">Activity Logs Last 30 Days</div>
          <div class="metric-value">{{ logs_last_30 }}</div>
        </div>
      </div>
    </div>

    <div class="col-6 col-md-4 col-xl-2">
      <div class="card metric-card shadow-sm h-100">
        <div class="card-body">
          <div class="metric-label">Deletes Last 30 Days</div>
          <div class="metric-value">{{ deletes_last_30 }}</div>
        </div>
      </div>
    </div>

    <div class="col-6 col-md-4 col-xl-2">
      <div class="card metric-card shadow-sm h-100">
        <div class="card-body">
          <div class="metric-label">CSV Imports Last 30 Days</div>
          <div class="metric-value">{{ csv_imports_last_30 }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts -->
  <div class="row g-3 mb-3">
    <div class="col-12 col-lg-7">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-white">
          <div class="fw-semibold">Activity Over Time</div>
          <div class="text-muted small">Logs per day, last 30 days.</div>
        </div>
        <div class="card-body">
          <div class="chart-box">
            <canvas id="logsLine"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-5">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-white">
          <div class="fw-semibold">Participants by Sex</div>
          <div class="text-muted small">Distribution across male and female.</div>
        </div>
        <div class="card-body">
          <div class="chart-box">
            <canvas id="sexDonut"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-7">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-white">
          <div class="fw-semibold">Participants by Territory</div>
          <div class="text-muted small">Counts based on each participant's center territory.</div>
        </div>
        <div class="card-body">
          <div class="chart-box tall">
            <canvas id="territoryBar"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-5">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-white">
          <div class="fw-semibold">Audit Actions</div>
          <div class="text-muted small">Counts for last 30 days.</div>
        </div>
        <div class="card-body">
          <div class="chart-box tall">
            <canvas id="actionsBar"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tables -->
  <div class="row g-3">
    <div class="col-12 col-xl-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-white">
          <div class="fw-semibold">Top Centers</div>
          <div class="text-muted small">Audit activity, last 30 days.</div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-sm table-striped mb-0">
              <thead>
                <tr>
                  <th class="ps-3">Center Code</th>
                  <th>Center Name</th>
                  <th class="text-end pe-3">Logs</th>
                </tr>
              </thead>
              <tbody>
                {% for c in top_centers %}
                  <tr>
                    <td class="ps-3">{{ c.project_center__center_code|default:"-" }}</td>
                    <td>{{ c.project_center__name|default:"-" }}</td>
                    <td class="text-end pe-3">{{ c.total }}</td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="3" class="text-muted ps-3 py-3">No activity found.</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-xl-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-white">
          <div class="fw-semibold">Top Users</div>
          <div class="text-muted small">Audit activity, last 30 days.</div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-sm table-striped mb-0">
              <thead>
                <tr>
                  <th class="ps-3">Username</th>
                  <th>Email</th>
                  <th class="text-end pe-3">Logs</th>
                </tr>
              </thead>
              <tbody>
                {% for u in top_users %}
                  <tr>
                    <td class="ps-3">{{ u.user__username|default:"-" }}</td>
                    <td>{{ u.user__email|default:"-" }}</td>
                    <td class="text-end pe-3">{{ u.total }}</td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="3" class="text-muted ps-3 py-3">No activity found.</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <div class="fw-semibold">Recent Audit Activity</div>
          <div class="text-muted small">Latest 20 actions across the system.</div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-sm table-hover mb-0">
              <thead>
                <tr>
                  <th class="ps-3">Timestamp</th>
                  <th>Action</th>
                  <th>User</th>
                  <th>Center</th>
                  <th>Participant ID</th>
                  <th class="pe-3">Details</th>
                </tr>
              </thead>
              <tbody>
                {% for log in recent_logs %}
                  <tr>
                    <td class="ps-3">{{ log.timestamp }}</td>
                    <td><span class="badge badge-ci">{{ log.action }}</span></td>
                    <td>{{ log.user.username }}</td>
                    <td>{{ log.project_center.center_code|default:"-" }}</td>
                    <td>{{ log.participant_id|default:"-" }}</td>
                    <td class="pe-3">{{ log.details|default:"" }}</td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="6" class="text-muted ps-3 py-3">No logs found.</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
<script>
  // Data from Django context
  const territoryLabels = {{ territory_labels|safe }};
  const territoryValues = {{ territory_values|safe }};

  const sexLabels = {{ sex_labels|safe }};
  const sexValues = {{ sex_values|safe }};

  const dateLabels = {{ date_labels|safe }};
  const dateValues = {{ date_values|safe }};

  const actionLabels = {{ action_labels|safe }};
  const actionValues = {{ action_values|safe }};

  // Compassion-like palette
  const CI_BLUE = getComputedStyle(document.documentElement).getPropertyValue("--ci-blue").trim() || "#0033A0";
  const CI_BLUE_2 = getComputedStyle(document.documentElement).getPropertyValue("--ci-blue-2").trim() || "#86BBE5";

  // Global defaults for a cleaner look
  Chart.defaults.color = "#475569";
  Chart.defaults.font.family = 'system-ui, -apple-system, "Segoe UI", Roboto, Arial';

  // Line: logs per day
  new Chart(document.getElementById("logsLine"), {
    type: "line",
    data: {
      labels: dateLabels,
      datasets: [{
        label: "Logs",
        data: dateValues,
        tension: 0.25,
        borderColor: CI_BLUE,
        backgroundColor: "rgba(0, 51, 160, 0.10)",
        fill: true,
        pointRadius: 2,
        pointHoverRadius: 4,
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: true, labels: { boxWidth: 10, usePointStyle: true } }
      },
      scales: {
        x: { ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 10 } },
        y: { beginAtZero: true, ticks: { precision: 0 } }
      }
    }
  });

  // Donut: sex distribution
  new Chart(document.getElementById("sexDonut"), {
    type: "doughnut",
    data: {
      labels: sexLabels,
      datasets: [{
        label: "Participants",
        data: sexValues,
        backgroundColor: [
          "rgba(0, 51, 160, 0.85)",
          "rgba(134, 187, 229, 0.95)",
          "rgba(0, 51, 160, 0.25)"
        ],
        borderColor: "#ffffff",
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: "65%",
      plugins: {
        legend: { position: "bottom", labels: { boxWidth: 10, usePointStyle: true } }
      }
    }
  });

  // Bar: territory counts
  new Chart(document.getElementById("territoryBar"), {
    type: "bar",
    data: {
      labels: territoryLabels,
      datasets: [{
        label: "Participants",
        data: territoryValues,
        backgroundColor: "rgba(0, 51, 160, 0.18)",
        borderColor: CI_BLUE,
        borderWidth: 1.5,
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: true, labels: { boxWidth: 10, usePointStyle: true } }
      },
      scales: {
        y: { beginAtZero: true, ticks: { precision: 0 } },
        x: { ticks: { autoSkip: true, maxTicksLimit: 12 } }
      }
    }
  });

  // Bar: actions last 30 days
  new Chart(document.getElementById("actionsBar"), {
    type: "bar",
    data: {
      labels: actionLabels,
      datasets: [{
        label: "Logs",
        data: actionValues,
        backgroundColor: "rgba(134, 187, 229, 0.60)",
        borderColor: CI_BLUE,
        borderWidth: 1.5,
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: true, labels: { boxWidth: 10, usePointStyle: true } }
      },
      scales: {
        y: { beginAtZero: true, ticks: { precision: 0 } }
      }
    }
  });
</script>
{% endblock %}