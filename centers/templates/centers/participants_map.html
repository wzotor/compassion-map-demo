{% extends "centers/base_staff.html" %}

{% block title %}Homes Map{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
{% endblock %}

{% block content %}
  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h3 class="mb-0">Homes Map</h3>
      {% if center %}
        <div class="text-muted">
          Project Center: <strong>{{ center.name }}</strong> ({{ center.center_code }})
        </div>
      {% endif %}
    </div>

    <div>
      <a class="btn btn-outline-secondary" href="{% url 'participant_list' %}">
        Back to Participants
      </a>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <div id="map" style="height: 70vh; width: 100%;"></div>
    </div>
  </div>

  {{ participants_json|json_script:"participants-data" }}
{% endblock %}

{% block extra_scripts %}
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
    const map = L.map("map");

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    const dataEl = document.getElementById("participants-data");
    const participants = dataEl ? JSON.parse(dataEl.textContent) : [];

    const points = [];

    // Create a cluster group and add it to the map
    const clusterGroup = L.markerClusterGroup();
    map.addLayer(clusterGroup);

    participants.forEach(p => {
      const lat = parseFloat(p.house_latitude);
      const lng = parseFloat(p.house_longitude);

      if (!Number.isNaN(lat) && !Number.isNaN(lng)) {
        points.push([lat, lng]);

        const popupHtml =
          "<div style='min-width:220px;'>" +
            "<div><strong>" + (p.participant_name || "") + "</strong></div>" +
            "<div>ID: " + (p.participant_id || "") + "</div>" +
            "<div>Caregiver: " + (p.caregiver_name || "") + "</div>" +
            "<div class='mt-2'>" +
              "<a target='_blank' href='https://www.google.com/maps/dir/?api=1&destination=" + lat + "," + lng + "'>" +
                "Navigate in Google Maps" +
              "</a>" +
            "</div>" +
          "</div>";

        const marker = L.marker([lat, lng]).bindPopup(popupHtml);
        clusterGroup.addLayer(marker);
      }
    });

    if (points.length > 0) {
      map.fitBounds(points, { padding: [30, 30] });
    } else {
      map.setView([7.9465, -1.0232], 6);
    }
  </script>
{% endblock %}
